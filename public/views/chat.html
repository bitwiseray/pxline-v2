<!DOCTYPE html>
<html lang="en" prefix="og: https://ogp.me/ns#">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A minimalistic vanilla chat app made in Node.js">
  <meta name="robots" content="follow, index">
  <meta name="author" content="PxLine Team">
  <meta name="theme-color" content="#7A2FFF">
  <meta name="keywords" content="chat app, nodejs chat app">
  <meta property="og:site_name" content="PxLine">
  <meta property="og:image" content="/assets/preview-logo.jpg">
  <meta property="og:image:width" content="300">
  <meta property="og:image:height" content="300">
  <meta property="og:locale" content="en_US">
  <title>PxLine â€” Chat</title>
  <link rel="icon" href="/public/assets/logo.jpg" type="image/x-icon">
  <link rel="stylesheet" href="/public/css/chat.css">
  <link rel="stylesheet" href="/public/css/toast.css">
  <link rel="stylesheet" href="/public/css/mode.css">
  <script defer src="/socket.io/socket.io.js"></script>
  <script defer src="/public/scripts/chat.js"></script>
  <script src="https://kit.fontawesome.com/c0b785182d.js" crossorigin="anonymous"></script>
  <link href='https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js" integrity="sha512-4F1cxYdMiAW98oomSLaygEwmCnIP38pb4Kx70yQYqRwLVCs3DbRumfBq82T08g/4LJ/smbFGFpmeFlQgoDccgg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <div class="toast-container"></div>
  <div class="toggle-container">
      <p class="content">Anonymous Mode</p>
      <input type="checkbox" id="check">
      <label for="check" class="button"><i class='bx bxs-hide'></i></label>
    </div>
  <div class="chat-container">
    <div class="chat-header">
      <div class="imgcontent">
        <a href="/"><i class="fa-solid fa-arrow-left"></i></a>
        <div class="imgBx">
          <img src="" alt="" />
        </div>
        <h3></h3>
        <div class="options-container">
          <input type="checkbox" id="dots">
          <label for="dots"><i class='bx bxs-hide'></i></label>
          <i class='bx bx-dots-vertical-rounded dots'></i>
        </div>
      </div>
    </div>
    <div class="message-container"></div>
    <div class="messageInput">
      <div class="input">
        <i class='bx bx-image-add' id='fileAddI'></i>
        <form action="/cdn" method="POST" enctype="multipart/form-data">
          <input type="file" id="attachmentInput" name="upload" style="display: none;" accept="image/*">
        </form>
        <input id="inp" type="text" placeholder="Message">
      </div>
      <div class="send"><i class='bx bx-send'></i></div>
    </div>
  </div>
  </div>
  <script src="/public/scripts/chat-ui.js"></script>
  <script>
    let messages = <%-JSON.stringify(messages)%>;
    const type = '<%=extType%>';
    const room = <%-JSON.stringify(extroom)%>;
    const extuser = <%-JSON.stringify(extusers)%>;
    const members = <%-JSON.stringify(extusers)%>;
    const user = <%-JSON.stringify(user)%>;
    const chats = <%-JSON.stringify(chats)%>;  
    function initChat() {
      if (type === 'room') {
        createChatHeader(room.title, room.icon);
        if (Array.isArray(chats.svd_chats) && chats.svd_chats.length >= 0) {
          chats.svd_chats.forEach(chat => {
            const senderUser = chat.sender === user._id ? user : members.find(member => member._id === chat.sender);
            appendMessage(senderUser.image, senderUser.display_name, chat.content.text, chat.content.timestamp, chat.attachments);
          });
        } else {
          console.error('Invalid chats object or svd_chats array');
        }
      } else {
        createChatHeader(extuser.display_name, extuser.image);
        if (Array.isArray(chats.svd_chats) && chats.svd_chats.length > 0) {
          chats.svd_chats.forEach(chat => {
            const senderUser = chat.sender === user._id ? user : extuser; // Assuming otherUser is available
            appendMessage(senderUser.image, senderUser.display_name, chat.content.text, chat.content.timestamp, chat.attachments);
          });
        } else {
         console.error('Invalid chats object or svd_chats array');
        }
      }
    }
    let isAttached;
    document.addEventListener('DOMContentLoaded', () => {
      const uploadIcon = document.getElementById('fileAddI');
      const uploadInput = document.getElementById('attachmentInput');
      uploadIcon.addEventListener('click', () => {
        uploadInput.click();
      });
      uploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const formData = new FormData();
        const reader = new FileReader();
        /*
        reader.onload = (e) => {
          appendTyping(user.image, user.display_name, 'awaitUpload', e.target.result)
        };
        */
        formData.append('upload', file);
          try {
            const response = await fetch('/cdn', {
              method: 'POST',
              body: formData
            });
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            const data = await response.json();
            isAttached = data;
          } catch (error) {
            alert('Something went wrong. Please try again later.');
            console.error('Fetch error:', error);
          }
        });
      });
    initChat();
  </script>
  <script src="/public/scripts/main.js"></script>
</body>
</html>
